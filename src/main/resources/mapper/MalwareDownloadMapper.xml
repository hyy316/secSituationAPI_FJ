<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.uway.mobile.mapper.MalwareDownloadMapper">
  <resultMap id="BaseResultMap" type="com.uway.mobile.domain.MalwareDownload">
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="meid" jdbcType="VARCHAR" property="meid" />
    <result column="imsi" jdbcType="VARCHAR" property="imsi" />
    <result column="city" jdbcType="VARCHAR" property="city" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="ename" jdbcType="VARCHAR" property="ename" />
    <result column="sourceip" jdbcType="VARCHAR" property="sourceip" />
    <result column="destip" jdbcType="VARCHAR" property="destip" />
    <result column="type" jdbcType="VARCHAR" property="type" />
    <result column="attribute" jdbcType="VARCHAR" property="attribute" />
    <result column="level" jdbcType="VARCHAR" property="level" />
    <result column="ostype" jdbcType="VARCHAR" property="ostype" />
    <result column="gettime" jdbcType="TIMESTAMP" property="gettime" />
    <result column="url" jdbcType="VARCHAR" property="url" />
    <result column="notify" jdbcType="INTEGER" property="notify" />
  </resultMap>
  <sql id="Base_Column_List">
    id, phone, meid, imsi, city, name, ename, sourceip, destip, type, attribute, level, 
    ostype, gettime, url, notify
  </sql>
     
  
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from malwareDownload
    where id = #{id,jdbcType=INTEGER}
  </select>
  <select id="getloadURL" parameterType="java.util.Map" resultType="java.util.Map">
		<![CDATA[ 	SELECT DISTINCT FROM_UNIXTIME(timekey*(60/6*60*24),'%Y-%m-%d %H:%i') time ,
		timeunit.timekey, COALESCE(dat.sum,0) sum FROM 
		(SELECT FLOOR(UNIX_TIMESTAMP(DATE_SUB(NOW(),
		 INTERVAL (@num:= @num + 60/6*24)-60/6*24 MINUTE))/(60/6*60*24)) AS timekey FROM malwareDownload,
		(SELECT @num:=0) t WHERE @num < 60*24 ORDER BY timekey ) timeunit LEFT JOIN 
		(SELECT FLOOR(UNIX_TIMESTAMP(gettime)/(60/6*60*24)) timekey2,url,
		COUNT(*) sum FROM malwareDownload WHERE 1=1 ]]>
		<if test="city != null and city != ''">
			AND city like CONCAT('%',#{city},'%')
		</if>
		<if test="timeRange != null and timeRange != ''">
			<![CDATA[ and gettime >= DATE_SUB(NOW(),INTERVAL  ${timeRange}) and gettime <= NOW()]]>
		</if>
		group by timekey2 )dat on timeunit.timekey = dat.timekey2 order by time
	</select>
	<insert id="insert" parameterType="java.util.List" >
   		 insert into malwareDownload 
   		 	(
   		 	phone, city, name,
   		 	type, attribute,
    		gettime, url, md5,ename,notify
		      )
		    values 
		    <foreach collection="list" item="item" index="index" separator=",">
		    (
		      #{item.phone},
		      #{item.city}, 
		      #{item.name},
		      #{item.type},
		      #{item.attribute}, 
		      #{item.gettime},
		      #{item.url}, 
		      #{item.md5},
		      #{item.ename},
		      #{item.notify}
		    )
    </foreach>
  </insert>
</mapper>