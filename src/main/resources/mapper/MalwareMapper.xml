<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.uway.mobile.mapper.MalwareMapper">
	<resultMap id="BaseResultMap" type="com.uway.mobile.domain.Malware">
	    <id column="id" jdbcType="INTEGER" property="id" />
	    <result column="phone" jdbcType="VARCHAR" property="phone" />
	    <result column="meid" jdbcType="VARCHAR" property="meid" />
	    <result column="imsi" jdbcType="VARCHAR" property="imsi" />
	    <result column="city" jdbcType="VARCHAR" property="city" />
	    <result column="name" jdbcType="VARCHAR" property="name" />
	    <result column="ename" jdbcType="VARCHAR" property="ename" />
	    <result column="filesize" jdbcType="INTEGER" property="filesize" />
	    <result column="type" jdbcType="VARCHAR" property="type" />
	    <result column="attribute" jdbcType="VARCHAR" property="attribute" />
	    <result column="level" jdbcType="VARCHAR" property="level" />
	    <result column="ostype" jdbcType="VARCHAR" property="ostype" />
	    <result column="sourceip" jdbcType="VARCHAR" property="sourceip" />
	    <result column="destip" jdbcType="VARCHAR" property="destip" />
	    <result column="gettime" jdbcType="TIMESTAMP" property="gettime" />
	    <result column="url" jdbcType="VARCHAR" property="url" />
	    <result column="md5" jdbcType="VARCHAR" property="md5" />
	</resultMap>
	<sql id="Base_Column_List">
		<if test="fields == null">
    		id, phone, meid, imsi, city, name, ename, filesize, type, attribute, level, ostype, 
    		sourceip, destip, gettime, url, md5,notify
		</if>
		<if test="fields != null">
			${fields}
		</if>
	</sql>
	
	<sql id="Base_Column_List_MalwareEvent">
    id, phone, meid, imsi, city, name, ename, sourceip, destip, type, attribute, level, 
    ostype, gettime, url, notify
  	</sql>
	
	
	<select id="getMalware" resultType="java.util.Map"
		parameterType="java.util.Map">
		select
		<include refid="Base_Column_List" />
		from malware where 1=1
		<if test="city != null and city != ''">
			AND city like CONCAT('%',#{city},'%')
		</if>
		<if test="timeRange != null and timeRange != ''">
			<![CDATA[ and getTime >= DATE_SUB(NOW(),INTERVAL  ${timeRange})  and gettime <= NOW()]]>
		</if>
		<if test="name != null and name != ''">
			AND name like  CONCAT('%',#{name},'%')
		</if>
		<if test="type != null and type != ''">
			AND type = #{type} 
		</if>
		<if test="attribute != null and attribute != ''">
			AND attribute = #{attribute} 
		</if>
		<if test="beginTime !=null and beginTime !=''">
            <![CDATA[
            and gettime >= #{beginTime}
            ]]>
		</if>
		<if test="endTime !=null and endTime !=''">
            <![CDATA[
            and gettime <= #{endTime}
            ]]>
		</if>
		<if test="notify !=null and notify !=''">   
            and notify = #{notify}
		</if>
		<if test="page_num != null">
			order by id asc limit #{page_num} , #{page_size}
		</if>
	</select>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		select
		<include refid="Base_Column_List" />
		from malware
		where id = #{id,jdbcType=INTEGER}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		delete from
		malware
		where id = #{id,jdbcType=INTEGER}
	</delete>

	<select id="countMalware" parameterType="java.util.Map"
		resultType="long">
		SELECT COUNT(1) FROM malware where 1=1
		<if test="city != null and city != ''">
			AND city like CONCAT('%',#{city},'%')
		</if>
		<if test="name != null and name != ''">
			AND name like  CONCAT('%',#{name},'%')
		</if>
		<if test="type != null and type != ''">
			AND type = #{type} 
		</if>
		<if test="attribute != null and attribute != ''">
			AND attribute = #{attribute} 
		</if>
		<if test="beginTime !=null and beginTime !=''">
            <![CDATA[
            and gettime >= #{beginTime}
            ]]>
		</if>
		<if test="endTime !=null and endTime !=''">
            <![CDATA[
            and gettime <= #{endTime}
            ]]>
		</if>
		<if test="timeRange != null and timeRange != ''">
			<![CDATA[ and gettime >= DATE_SUB(NOW(),INTERVAL  ${timeRange})  and gettime <= NOW()]]>
		</if>
	</select>

	<select id="groupByParm" parameterType="java.util.Map"
		resultType="java.util.Map">
		SELECT ${groupfields},COUNT(1) sum FROM malware where 1=1
		<if test="city != null and city != ''">
			AND city like CONCAT('%',#{city},'%')
		</if>
		<if test="name != null and name != ''">
			AND name like  CONCAT('%',#{name},'%')
		</if>
		<if test="type != null and type != ''">
			AND type = #{type} 
		</if>
		<if test="attribute != null and attribute != ''">
			AND attribute = #{attribute} 
		</if>
		<if test="beginTime !=null and beginTime !=''">
            <![CDATA[
            and gettime >= #{beginTime}
            ]]>
		</if>
		<if test="endTime !=null and endTime !=''">
            <![CDATA[
            and gettime <= #{endTime}
            ]]>
		</if>
		<if test="timeRange != null and timeRange != ''">
			<![CDATA[ and gettime >= DATE_SUB(NOW(),INTERVAL  ${timeRange})  and gettime <= NOW() ]]>
		</if>
		group by ${groupfields} order by sum desc LIMIT #{topn}
	</select>

	<select id="groupByTime" parameterType="java.util.Map"
		resultType="java.util.Map">
		<![CDATA[ 		select FROM_UNIXTIME(timekey*(60/${size}*60*${hours}),'%Y-%m-%d %H:%i')
		 time ,timeunit.timekey,coalesce(dat.sum,0) sum from
		(select floor(unix_timestamp(date_sub(now(), 
		INTERVAL (@num:= @num + 60/${size}*${hours})-60/${size}*${hours} MINUTE))
		/(60/${size}*60*${hours})) as timekey 
		from malware ,(select @num:=0) t 
		where @num < 60*${hours} order by timekey
		 ) timeunit left join 
		(select floor(unix_timestamp(gettime)/(60/${size}*60*${hours})) timekey2,count(*) sum
		FROM malware where 1=1  ]]>
		<if test="city != null and city != ''">
			AND city like CONCAT('%',#{city},'%')
		</if>
		<if test="name != null and name != ''">
			AND name like  CONCAT('%',#{name},'%')
		</if>
		<if test="type != null and type != ''">
			AND type = #{type} 
		</if>
		<if test="attribute != null and attribute != ''">
			AND attribute = #{attribute} 
		</if>
		<if test="timeRange != null and timeRange != ''">
			<![CDATA[ and gettime >= DATE_SUB(NOW(),INTERVAL  ${timeRange}) and gettime <= NOW()]]>
		</if>
		group by timekey2 ) dat on timeunit.timekey = dat.timekey2 order by time
	</select>

	<!-- <select id="getByURL" parameterType="java.util.Map" resultType="java.util.Map">
		<![CDATA[ 	SELECT DISTINCT FROM_UNIXTIME(timekey*(60/6*60*24),'%Y-%m-%d %H:%i') time ,
		timeunit.timekey, COALESCE(dat.sum,0) sum FROM 
		(SELECT FLOOR(UNIX_TIMESTAMP(DATE_SUB(NOW(),
		 INTERVAL (@num:= @num + 60/6*24)-60/6*24 MINUTE))/(60/6*60*24)) AS timekey FROM malware ,
		(SELECT @num:=0) t WHERE @num < 60*24 ORDER BY timekey ) timeunit LEFT JOIN 
		(SELECT FLOOR(UNIX_TIMESTAMP(gettime)/(60/6*60*24)) timekey2,url,
		COUNT(*) sum FROM malware WHERE 1=1 ]]>
		<if test="city != null and city != ''">
			AND city like CONCAT('%',#{city},'%')
		</if>
		<if test="timeRange != null and timeRange != ''">
			<![CDATA[ and gettime >= DATE_SUB(NOW(),INTERVAL  ${timeRange}) and gettime <= NOW()]]>
		</if>
		group by timekey2 )dat on timeunit.timekey = dat.timekey2 order by time
	</select> -->
	
	<select id="getByName" parameterType="java.util.Map" resultType="java.util.Map">
			<![CDATA[ 		select DISTINCT FROM_UNIXTIME(timekey*(60/${size}*60*${hours}),'%Y-%m-%d %H:%i') time ,timeunit.timekey, coalesce(dat.sum,0) sum from
			(select floor(unix_timestamp(date_sub(now(), 
			INTERVAL (@num:= @num + 60/${size}*${hours})-60/${size}*${hours} MINUTE))/(60/${size}*60*${hours})) as timekey 
			from malware ,(select @num:=0) t 
			where @num < 60*${hours} order by timekey
			 ) timeunit left join
			(select floor(unix_timestamp(gettime)/(60/${size}*60*${hours})) timekey2,md5,count(*) sum
			FROM malware where 1=1  ]]>
			<if test="city != null and city != ''">
				AND city like CONCAT('%',#{city},'%')
			</if>
			<if test="timeRange != null and timeRange != ''">
				<![CDATA[ and gettime >= DATE_SUB(NOW(),INTERVAL  ${timeRange}) and gettime <= NOW()]]>
			</if>
			group by timekey2 ) dat on timeunit.timekey = dat.timekey2  order by time
	</select>
	<select id="groupByParmUnion" parameterType="java.util.Map"
		resultType="java.util.Map">
		SELECT ${groupfields}, sum(cnt) sum from 
		
		(
			select ${groupfields} ,count(1) cnt from  malwareDownload where 1=0 
			<if test="city != null and city != ''">
			AND city like CONCAT('%',#{city},'%')
		</if>
		<if test="beginTime !=null and beginTime !=''">
            <![CDATA[
            and gettime >= #{beginTime}
            ]]>
		</if>
		<if test="endTime !=null and endTime !=''">
            <![CDATA[
            and gettime <= #{endTime}
            ]]>
		</if>
		<if test="timeRange != null and timeRange != ''">
			<![CDATA[ and gettime >= DATE_SUB(NOW(),INTERVAL  ${timeRange})  and gettime <= NOW()]]>
		</if>
			group by city 
			union
			select ${groupfields} ,count(1) cnt from  malwareControl  where 1=1 
			<if test="city != null and city != ''">
			AND city like CONCAT('%',#{city},'%')
		</if>
		<if test="beginTime !=null and beginTime !=''">
            <![CDATA[
            and gettime >= #{beginTime}
            ]]>
		</if>
		<if test="endTime !=null and endTime !=''">
            <![CDATA[
            and gettime <= #{endTime}
            ]]>
		</if>
		<if test="timeRange != null and timeRange != ''">
			<![CDATA[ and gettime >= DATE_SUB(NOW(),INTERVAL  ${timeRange})  and gettime <= NOW()]]>
		</if>
			group by ${groupfields} 
		) unrlt group by ${groupfields}
		 order by sum desc LIMIT #{topn}
	</select>
	
	<select id="getMalwareEvent" resultType="java.util.Map" parameterType="java.util.Map">
		
		SELECT 
		<include refid="Base_Column_List_MalwareEvent" />
		 	from malware_Control_Down_view  where 1=1
		<if test="city != null and city != ''">
			AND city like CONCAT('%',#{city},'%')
		</if>
		<if test="name != null and name != ''">
			AND name like  CONCAT('%',#{name},'%')
		</if>
		<if test="type != null and type != ''">
			AND type = #{type} 
		</if>
		<if test="attribute != null and attribute != ''">
			AND attribute = #{attribute} 
		</if>
		<if test="beginTime !=null and beginTime !=''">
            <![CDATA[
            and gettime >= #{beginTime}
            ]]>
		</if>
		<if test="endTime !=null and endTime !=''">
            <![CDATA[
            and gettime <= #{endTime}
            ]]>
		</if>
		<if test="timeRange != null and timeRange != ''">
			<![CDATA[ and gettime >= DATE_SUB(NOW(),INTERVAL  ${timeRange})  and gettime <= NOW()]]>
		</if>
		<if test="page_num != null">
			order by id asc limit #{page_num} , #{page_size}
		</if>
	</select>
	
	
	
	<select id="countMalwareEvent" parameterType="java.util.Map"
		resultType="long">
		
		SELECT COUNT(1) FROM 
		(
		select id from malwareControl  where 1=1
		<if test="city != null and city != ''">
			AND city like CONCAT('%',#{city},'%')
		</if>
		<if test="name != null and name != ''">
			AND name like  CONCAT('%',#{name},'%')
		</if>
		<if test="type != null and type != ''">
			AND type = #{type} 
		</if>
		<if test="attribute != null and attribute != ''">
			AND attribute = #{attribute} 
		</if>
		<if test="beginTime !=null and beginTime !=''">
            <![CDATA[
            and gettime >= #{beginTime}
            ]]>
		</if>
		<if test="endTime !=null and endTime !=''">
            <![CDATA[
            and gettime <= #{endTime}
            ]]>
		</if>
		<if test="timeRange != null and timeRange != ''">
			<![CDATA[ and gettime >= DATE_SUB(NOW(),INTERVAL  ${timeRange})  and gettime <= NOW()]]>
		</if>
		union all
		
		select id from malwareDownload where 1=0
		<if test="city != null and city != ''">
			AND city like CONCAT('%',#{city},'%')
		</if>
		<if test="name != null and name != ''">
			AND name like  CONCAT('%',#{name},'%')
		</if>
		<if test="type != null and type != ''">
			AND type = #{type} 
		</if>
		<if test="attribute != null and attribute != ''">
			AND attribute = #{attribute} 
		</if>
		<if test="beginTime !=null and beginTime !=''">
            <![CDATA[
            and gettime >= #{beginTime}
            ]]>
		</if>
		<if test="endTime !=null and endTime !=''">
            <![CDATA[
            and gettime <= #{endTime}
            ]]>
		</if>
		<if test="timeRange != null and timeRange != ''">
			<![CDATA[ and gettime >= DATE_SUB(NOW(),INTERVAL  ${timeRange})  and gettime <= NOW()]]>
		</if>
		) malevent
		
	</select>
	
	
	
	
	
	
	
	
	
	
	
	<insert id="insertBath" parameterType="java.util.List" >
   		 insert into malware 
   		 	(
   		 	phone, city, name,
   		 	type, attribute,
    		gettime, url, md5,ename,notify
		      )
		    values 
		    <foreach collection="list" item="item" index="index" separator=",">
		    (
		      #{item.phone},
		      #{item.city}, 
		      #{item.name},
		      #{item.type},
		      #{item.attribute}, 
		      #{item.gettime},
		      #{item.url}, 
		      #{item.md5},
		      #{item.ename},
		      #{item.notify}
		    )
    </foreach>
  </insert>
	

</mapper>